knitr::opts_chunk$set(echo = TRUE)
if(!require('pacman')) {install.packages('pacman')}
pacman::p_load(openxlsx, dplyr, tidyr, reshape2, stringr)
# BiocManager::install("GenomicRanges")
library(GenomicRanges)
source('libraryDesignFunctions.R')
wd <- getwd()
wd # verify directory location
targetGDO <- read.xlsx(paste0(wd,"//output//finalTargetGDOi30.xlsx"))
# TSPAN14 3x SNP region:
# 1) remove sequences:
# AAGGAGGATTGCAGCTGGTA, ACAAGAGCCTTGCATTGCAC, TCCCTGGAATATGTGCCCAG
removeGDO <- c("AAGGAGGATTGCAGCTGGTA", "ACAAGAGCCTTGCATTGCAC", "TCCCTGGAATATGTGCCCAG")
test <- subset(targetGDO, !(Seq %in% removeGDO))
View(targetGDO)
test <- subset(targetGDO, !(sgRNA.Sequence %in% removeGDO))
# 2) Change region name to rs1870137|rs1870138|rs7080009 for seqs:
# CTTAGGCGCTGCATACCGTA, GGAACAAGCCACTCCACCTC, GAACTGCTTAGACAAACCCC
keepGDO <- c("CTTAGGCGCTGCATACCGTA", "GGAACAAGCCACTCCACCTC", "GAACTGCTTAGACAAACCCC")
test <- test %>%
mutate(SNP = ifelse(sgRNA.Sequence %in% keepGDO, "rs1|rs2|rs3"))
test <- test %>%
mutate(SNP = ifelse(sgRNA.Sequence %in% keepGDO, "rs1|rs2|rs3", SNP))
View(test)
test <- test %>%
mutate(SNP = ifelse(sgRNA.Sequence %in% keepGDO, "rs1870137|rs1870138|rs7080009", SNP))
# TSPAN14 3x SNP region:
# 1) remove sequences:
# AAGGAGGATTGCAGCTGGTA, ACAAGAGCCTTGCATTGCAC, TCCCTGGAATATGTGCCCAG
removeGDO <- c("AAGGAGGATTGCAGCTGGTA", "ACAAGAGCCTTGCATTGCAC", "TCCCTGGAATATGTGCCCAG")
targetGDO <- subset(targetGDO, !(sgRNA.Sequence %in% removeGDO))
# 2) Change region name to rs1870137|rs1870138|rs7080009 for seqs:
# CTTAGGCGCTGCATACCGTA, GGAACAAGCCACTCCACCTC, GAACTGCTTAGACAAACCCC
keepGDO <- c("CTTAGGCGCTGCATACCGTA", "GGAACAAGCCACTCCACCTC", "GAACTGCTTAGACAAACCCC")
targetGDO <- targetGDO %>%
mutate(SNP = ifelse(sgRNA.Sequence %in% keepGDO, "rs1870137|rs1870138|rs7080009", SNP))
# Remove the bad performing guide
test <- subset(targetGDO, sgRNA.Sequence != "AGAACAATAAAAACTACGGT")
# Load Guide Pool, subset for region of interest, remove guide that you don't want from the pool and repick.
guidePool <- read.xlsx(paste0(wd, "//preprocessed//200bp_i30.xlsx"))
guidePool <- subset(guidePool, (region == "rs8003334|rs8019279|rs8019585")&(sgRNA.Sequence != "AGAACAATAAAAACTACGGT"))
# Load Guide Pool, subset for region of interest, remove guide that you don't want from the pool and repick.
guidePool <- read.xlsx(paste0(wd, "//preprocessed//200bp_i30.xlsx"))
guidePool <- subset(guidePool, (SNP == "rs8003334|rs8019279|rs8019585")&(sgRNA.Sequence != "AGAACAATAAAAACTACGGT"))
View(guidePool)
guidePool <- filterGDO(guidePool, minOnScore = 0.2)
dirRegion <- paste0(wd,"//preprocessed//")
dirGDO <- paste0(wd, "//preprocessed//")
fileList <- c("200bp_i30","300bp_i30","400bp_i30","500bp_i30","600bp_i30")
guidePool400 <- read.xlsx(paste0(wd, "//preprocessed//400bp_i30.xlsx"))
guidePool400 <- subset(guidePool400, (SNP == "rs8003334|rs8019279|rs8019585")&(sgRNA.Sequence != "AGAACAATAAAAACTACGGT"))
guidePool400 <- filterGDO(guidePool400, minOnScore = 0.2)
View(guidePool400)
# Add this one: TGGAACTCTCAAGTACTGCC
test <- bind_rows(test, subset(guidePool, sgRNA.Sequence=="TGGAACTCTCAAGTACTGCC"))
View(test)
# Remove the bad performing guide
test <- subset(targetGDO, sgRNA.Sequence != "AGAACAATAAAAACTACGGT")
# Load Guide Pool, subset for region of interest, remove guide that you don't want from the pool and repick.
guidePool <- read.xlsx(paste0(wd, "//preprocessed//200bp_i30.xlsx"))
guidePool <- subset(guidePool, (SNP == "rs8003334|rs8019279|rs8019585")&(sgRNA.Sequence != "AGAACAATAAAAACTACGGT"))
guidePool <- filterGDO(guidePool, minOnScore = 0.2)
# guidePool400 <- read.xlsx(paste0(wd, "//preprocessed//400bp_i30.xlsx"))
# guidePool400 <- subset(guidePool400, (SNP == "rs8003334|rs8019279|rs8019585")&(sgRNA.Sequence != "AGAACAATAAAAACTACGGT"))
# guidePool400 <- filterGDO(guidePool400, minOnScore = 0.2)
# Add this one: TGGAACTCTCAAGTACTGCC
test <- bind_rows(test, subset(guidePool, sgRNA.Sequence=="TTTCTGGGTCATATGATAAG"))
View(test)
View(guidePool400)
guidePool <- read.xlsx(paste0(wd, "//preprocessed//400bp_i30.xlsx"))
guidePool <- subset(guidePool, (SNP == "rs8003334|rs8019279|rs8019585")&(sgRNA.Sequence != "AGAACAATAAAAACTACGGT")&(Orientation=="antisense"))
guidePool <- filterGDO(guidePool, minOnScore = 0.2)
# Remove the bad performing guide
targetGDO <- subset(targetGDO, sgRNA.Sequence != "AGAACAATAAAAACTACGGT")
# Load Guide Pool, subset for region of interest, remove guide that you don't want from the pool and repick.
guidePool <- read.xlsx(paste0(wd, "//preprocessed//200bp_i30.xlsx"))
guidePool <- subset(guidePool, (SNP == "rs8003334|rs8019279|rs8019585")&(sgRNA.Sequence != "AGAACAATAAAAACTACGGT")&(Orientation=="antisense"))
guidePool <- filterGDO(guidePool, minOnScore = 0.2)
guidePool <- read.xlsx(paste0(wd, "//preprocessed//400bp_i30.xlsx"))
guidePool <- subset(guidePool, (SNP == "rs8003334|rs8019279|rs8019585")&(sgRNA.Sequence != "AGAACAATAAAAACTACGGT")&(Orientation=="antisense"))
guidePool <- filterGDO(guidePool, minOnScore = 0.2)
# Add this one: TGGAACTCTCAAGTACTGCC
targetGDO <- bind_rows(targetGDO, subset(guidePool, sgRNA.Sequence=="ACAGGTCTTTGTGGGAACAT"))
View(targetGDO)
# Remove the least interesting guide
# ACTGCGCGCAGGGTGGAAGT
targetGDO <- subset(targetGDO, sgRNA.Sequence != "AGAACAATAAAAACTACGGT")
# Add in the guide that hit 3 genes
guidePool <- read.xlsx(paste0(wd, "//preprocessed//200bp_i30.xlsx"))
test <- bind_rows(targetGDO, subset(guidePool, sgRNA.Sequence=="AGAGCTAGACTTGCAAGGGG"))
# Remove the least interesting guide
# ACTGCGCGCAGGGTGGAAGT
targetGDO <- subset(targetGDO, sgRNA.Sequence != "ACTGCGCGCAGGGTGGAAGT")
test <- bind_rows(targetGDO, subset(guidePool, sgRNA.Sequence=="AGAGCTAGACTTGCAAGGGG"))
# Add in the guide that hit 3 genes
guidePool <- read.xlsx(paste0(wd, "//preprocessed//400bp_i30.xlsx"))
test <- bind_rows(targetGDO, subset(guidePool, sgRNA.Sequence=="AGAGCTAGACTTGCAAGGGG"))
wd <- getwd()
wd # verify directory location
targetGDO <- read.xlsx(paste0(wd,"//output//finalTargetGDOi30.xlsx"))
# TSPAN14 3x SNP region:
# 1) remove sequences:
# AAGGAGGATTGCAGCTGGTA, ACAAGAGCCTTGCATTGCAC, TCCCTGGAATATGTGCCCAG
removeGDO <- c("AAGGAGGATTGCAGCTGGTA", "ACAAGAGCCTTGCATTGCAC", "TCCCTGGAATATGTGCCCAG")
targetGDO <- subset(targetGDO, !(sgRNA.Sequence %in% removeGDO))
# 2) Change region name to rs1870137|rs1870138|rs7080009 for seqs:
# CTTAGGCGCTGCATACCGTA, GGAACAAGCCACTCCACCTC, GAACTGCTTAGACAAACCCC
keepGDO <- c("CTTAGGCGCTGCATACCGTA", "GGAACAAGCCACTCCACCTC", "GAACTGCTTAGACAAACCCC")
targetGDO <- targetGDO %>%
mutate(SNP = ifelse(sgRNA.Sequence %in% keepGDO, "rs1870137|rs1870138|rs7080009", SNP))
# Remove the bad performing guide
targetGDO <- subset(targetGDO, sgRNA.Sequence != "AGAACAATAAAAACTACGGT")
# Load Guide Pool, subset for region of interest, remove guide that you don't want from the pool and repick.
guidePool <- read.xlsx(paste0(wd, "//preprocessed//200bp_i30.xlsx"))
guidePool <- subset(guidePool, (SNP == "rs8003334|rs8019279|rs8019585")&(sgRNA.Sequence != "AGAACAATAAAAACTACGGT")&(Orientation=="antisense"))
guidePool <- filterGDO(guidePool, minOnScore = 0.2)
# Not a lot of guides, try slightly expanded region.
guidePool <- read.xlsx(paste0(wd, "//preprocessed//400bp_i30.xlsx"))
guidePool <- subset(guidePool, (SNP == "rs8003334|rs8019279|rs8019585")&(sgRNA.Sequence != "AGAACAATAAAAACTACGGT")&(Orientation=="antisense"))
guidePool <- filterGDO(guidePool, minOnScore = 0.2)
# Add this one (antisense): TGGAACTCTCAAGTACTGCC
targetGDO <- bind_rows(targetGDO, subset(guidePool, sgRNA.Sequence=="ACAGGTCTTTGTGGGAACAT"))
# Add in the guide that hit 3 genes
guidePool <- read.xlsx(paste0(wd, "//preprocessed//400bp_i30.xlsx"))
guidePool <- subset(guidePool, (SNP == "rs4318227")&!(sgRNA.Sequence %in% removeGDO)&(Orientation=="antisense"))
guidePool <- filterGDO(guidePool, minOnScore = 0.2)
View(guidePool)
# Add in the guide that hit 3 genes
guidePool <- read.xlsx(paste0(wd, "//preprocessed//400bp_i30.xlsx"))
guidePool <- subset(guidePool, (SNP == "rs4318227")&!(sgRNA.Sequence %in% removeGDO)&(Orientation=="sense"))
guidePool <- filterGDO(guidePool, minOnScore = 0.2)
View(test)
# Remove the least interesting guide
# ACTGCGCGCAGGGTGGAAGT
removeGDO <- c("ACTGCGCGCAGGGTGGAAGT")
targetGDO <- subset(targetGDO, !(sgRNA.Sequence %in% removeGDO))
# Add in the guide that hit 3 genes
guidePool <- read.xlsx(paste0(wd, "//preprocessed//400bp_i30.xlsx"))
guidePool <- subset(guidePool, (SNP == "rs4318227")&!(sgRNA.Sequence %in% removeGDO)&(Orientation=="sense"))
guidePool <- filterGDO(guidePool, minOnScore = 0.2)
targetGDO <- bind_rows(targetGDO, subset(guidePool, sgRNA.Sequence=="AGAGCTAGACTTGCAAGGGG"))
# Add in the guide that hit 3 genes
guidePool <- read.xlsx(paste0(wd, "//preprocessed//400bp_i30.xlsx"))
guidePool <- subset(guidePool, (SNP == "rs4318227"))
guidePool <- filterGDO(guidePool, minOnScore = 0.2)
targetGDO <- bind_rows(targetGDO, subset(guidePool, sgRNA.Sequence=="AGAGCTAGACTTGCAAGGGG"))
View(targetGDO)
# Removing the worst pick order ranked guide
targetGDO <- subset(targetGDO, sgRNA.Sequence != "TCCGGGTGGGGTAGGCACAC")
guidePool <- read.xlsx(paste0(wd, "//preprocessed//200bp_i30.xlsx"))
test <- bind_rows(targetGDO, subset(guidePool, sgRNA.Sequence=="GCCAAGCGCGGGTTCTGGAA"))
guidePool <- read.xlsx(paste0(wd, "//preprocessed//400bp_i30.xlsx"))
test <- bind_rows(targetGDO, subset(guidePool, sgRNA.Sequence=="GCCAAGCGCGGGTTCTGGAA"))
View(test)
targetGDO <- bind_rows(targetGDO, subset(guidePool, sgRNA.Sequence=="GCCAAGCGCGGGTTCTGGAA"))
View(guidePool)
# GTTCTATGTCTTGTAGCCCA
targetGDO <- subset(targetGDO, sgRNA.Sequence != "GTTCTATGTCTTGTAGCCCA")
guidePool <- read.xlsx(paste0(wd, "//preprocessed//200bp_i30.xlsx"))
targetGDO <- bind_rows(targetGDO, subset(guidePool, sgRNA.Sequence=="AGCATGCCAGGCCTAGATCG"))
guidePool <- read.xlsx(paste0(wd, "//preprocessed//400bp_i30.xlsx"))
targetGDO <- bind_rows(targetGDO, subset(guidePool, sgRNA.Sequence=="AGCATGCCAGGCCTAGATCG"))
View(targetGDO)
targetGDO <- subset(targetGDO, sgRNA.Sequence != "TTGGGCTTCAGCTTGAGGAC")
guidePool <- read.xlsx(paste0(wd, "//preprocessed//400bp_i30.xlsx"))
targetGDO <- bind_rows(targetGDO, subset(guidePool, sgRNA.Sequence=="TCTGCAGAATGGCACTGACA"))
View(targetGDO)
View(targetGDO)
write.xlsx(targetGDO, file = paste0(wd, "//output//finalTargetGDOi30_wPilot.xlsx"))
knitr::opts_chunk$set(echo = TRUE)
if(!require('pacman')) {install.packages('pacman')}
pacman::p_load(openxlsx, dplyr, tidyr, reshape2, stringr)
# BiocManager::install("GenomicRanges")
library(GenomicRanges)
source('libraryDesignFunctions.R')
# Load Data
wd <- getwd()
wd # verify directory location
# Load all SNPs.
snp_list <- unique(read.xlsx(paste0(wd,"//input//adtlROIhg19.xlsx")))
rownames(snp_list) <- NULL
snp_list$chr <- as.character(snp_list$chr)
# Get refseq conversion for chromosome numbers. Needed for compatibility with CRISPick
refseqLookup <- read.delim(paste0(wd,"//input//seq_report_hg19.tsv"))
refseqLookup <- subset(refseqLookup, Role=="assembled-molecule")
# Rename columns for convenience
names(refseqLookup)[names(refseqLookup)=="Chromosome.name"] <- "chr"
names(refseqLookup)[names(refseqLookup)=="RefSeq.seq.accession"] <- "refseq"
refseqLookup <- refseqLookup %>%
select(chr, refseq)
# -----------------------------------------------------------------------------
# Preprocess Input for CRISPick
# Combine nearby SNP regions.
# Use 200bp for first pass. Expand region size for any 200bp regions
# that don't have enough good quality guides.
regions200 <- findSnpRegions(200, snp_list)
regions300 <- findSnpRegions(300, snp_list)
regions400 <- findSnpRegions(400, snp_list)
# Convert to CRISPick format
regions200 <- formatCrispick(regions200, refseqLookup)
regions300 <- formatCrispick(regions300, refseqLookup)
regions400 <- formatCrispick(regions400, refseqLookup)
# Only need the 'crispick' column to run CRISPick for library design.
crispick200Input <- regions200 %>% select(crispick)
crispick300Input <- regions300 %>% select(crispick)
crispick400Input <- regions400 %>% select(crispick)
# -----------------------------------------------------------------------------
# Export SNP regions as regions file and in fasta file for CRISPick Input.
# Save SNP regions
write.xlsx(regions200, file = paste0(wd, "//preprocessed//adtlRegions200.xlsx"))
write.xlsx(regions300, file = paste0(wd, "//preprocessed//adtlRegions300.xlsx"))
write.xlsx(regions400, file = paste0(wd, "//preprocessed//adtlRegions400.xlsx"))
# Save CRISPick Inputs
write.table(crispick200Input, paste0(wd, "//preprocessed//adtlLoc200.fasta"),
row.names=FALSE, col.names=FALSE, quote=FALSE)
write.table(crispick300Input, paste0(wd, "//preprocessed//adtlLoc300.fasta"),
row.names=FALSE, col.names=FALSE, quote=FALSE)
write.table(crispick400Input, paste0(wd, "//preprocessed//adtlLoc400.fasta"),
row.names=FALSE, col.names=FALSE, quote=FALSE)
wd <- getwd()
# Import refseq vs chromosome number lookup.
refseqLookup <- read.xlsx(paste0(wd, "//input//refseqLookup.xlsx"))
# Import SNP-to-region annotations.
regions200 <- read.xlsx(paste0(wd,"//preprocessed//adtlRegions200.xlsx"))
regions300 <- read.xlsx(paste0(wd,"//preprocessed//adtlRegions300.xlsx"))
regions400 <- read.xlsx(paste0(wd,"//preprocessed//adtlRegions400.xlsx"))
# Indicate columns of interest.
# Re: Num. of Off-Target hits:
# Tier I - coding genes
# Tier II - non-coding genes
# Tier III - all other regions
# Bin I - perfect match
# Bin II - ~a few mismatched bases
keepCol <- c("Input", "Reference.Sequence", "Orientation", "sgRNA.'Cut'.Position",
"sgRNA.Sequence", "sgRNA.Context.Sequence", "On-Target.Efficacy.Score",
"#.Off-Target.Tier.I.Match.Bin.I.Matches", "#.Off-Target.Tier.II.Match.Bin.I.Matches",
"#.Off-Target.Tier.III.Match.Bin.I.Matches", "#.Off-Target.Tier.I.Match.Bin.II.Matches",
"#.Off-Target.Tier.II.Match.Bin.II.Matches", "#.Off-Target.Tier.III.Match.Bin.II.Matches",
"On-Target.Rank", "Off-Target.Rank",
"Pick.Order")
# >>> add smth for OFF-targets
# Get filenames of CRISPick outputs.
setwd(paste0(wd,'\\crispick_output'))
file_list <- list.files(pattern= "^sgrna_cre.*\\.xlsx$")
file_list <- list.files(pattern= "^adtl_sgrna_cre.*\\.xlsx$")
setwd(paste0(wd,'\\crispick_output'))
file_list <- list.files(pattern= "^adtl_sgrna_cre.*\\.xlsx$")
file_list
# Loop through all files from CRISPick output.
for (file in file_list){
# Import CRISPick Output
GDOraw <- read.xlsx(paste0(wd,"//crispick_output//",file))
# Keep important columns.
GDOout <- select(GDOraw, all_of(keepCol))
# Filter GC %, TTTT, On-Target Efficacy > 0.2
GDOout <- filterGDO(GDOout)
# Add GDO Locations: chromosome # + start/end coordinates.
GDOout <- addGDOLoc(GDOout, refseqLookup)
# Add the SNP region.
if (grepl("200", file)){
GDOout <- left_join(GDOout, select(regions200, SNP, crispick), join_by("Input"=="crispick"))
GDOout$regWidth <- 200
} else if (grepl("300", file)){
GDOout <- left_join(GDOout, select(regions300, SNP, crispick), join_by("Input"=="crispick"))
GDOout$regWidth <- 300
} else if (grepl("400", file)){
GDOout <- left_join(GDOout, select(regions400, SNP, crispick), join_by("Input"=="crispick"))
GDOout$regWidth <- 400
}
# Add rownumber for reference later.
GDOout$n <- as.numeric(rownames(GDOout))
# Export preprocessed GDO pools.
# Filename is substring of CRISPick output file name:
# i.e. output "600bp_i50.xlsx" as derived from "sgrna_cre_600bp_i50.xlsx"
write.xlsx(GDOout, file = paste0(wd, "//preprocessed//", sub("^adtl_sgrna_cre_(.*)$", "\\1", file)))
}
# Loop through all files from CRISPick output.
for (file in file_list){
# Import CRISPick Output
GDOraw <- read.xlsx(paste0(wd,"//crispick_output//",file))
# Keep important columns.
GDOout <- select(GDOraw, all_of(keepCol))
# Filter GC %, TTTT, On-Target Efficacy > 0.2
GDOout <- filterGDO(GDOout)
# Add GDO Locations: chromosome # + start/end coordinates.
GDOout <- addGDOLoc(GDOout, refseqLookup)
# Add the SNP region.
if (grepl("200", file)){
GDOout <- left_join(GDOout, select(regions200, SNP, crispick), join_by("Input"=="crispick"))
GDOout$regWidth <- 200
} else if (grepl("300", file)){
GDOout <- left_join(GDOout, select(regions300, SNP, crispick), join_by("Input"=="crispick"))
GDOout$regWidth <- 300
} else if (grepl("400", file)){
GDOout <- left_join(GDOout, select(regions400, SNP, crispick), join_by("Input"=="crispick"))
GDOout$regWidth <- 400
}
# Add rownumber for reference later.
GDOout$n <- as.numeric(rownames(GDOout))
# Export preprocessed GDO pools.
# Filename is substring of CRISPick output file name:
# i.e. output "600bp_i50.xlsx" as derived from "sgrna_cre_600bp_i50.xlsx"
write.xlsx(GDOout, file = paste0(wd, "//preprocessed//","adtl", sub("^adtl_sgrna_cre_(.*)$", "\\1", file)))
}
wd <- getwd()
wd # verify directory location
# Set universal directories:
dirRegion <- paste0(wd,"//preprocessed//")
dirGDO <- paste0(wd, "//preprocessed//")
snpList <- unique(read.xlsx(paste0(wd,"//input//adtlROIhg19.xlsx")))
rownames(snpList) <- NULL
snpList$chr <- as.character(snpList$chr)
regionList <- c("adtlRegions200", "adtlRegions300", "adtlRegions400")
fileList <- c("adtl200bp_i30","adtl300bp_i30","adtl400bp_i30")
targetGDO <- assembleLibrary(3, fileList, regionList, dirGDO, dirRegion,
onTargetFilter = 0.2, pickByStrand = TRUE, overlapLeniency=2)
uniqueGDO <- unique(targetGDO)
nrow(uniqueGDO) == nrow(targetGDO)
overlap <- findSelfOverlap(targetGDO, "chr", "start","end", selfBool=TRUE)
overlapLenient <- findSelfOverlap(targetGDO, "chr", "startL","endL", selfBool=TRUE)
qcSimple(targetGDO)
qcSumOff(targetGDO)
orient <- qcStrand(targetGDO)
View(targetGDO)
write.xlsx(targetGDO, file = paste0(wd, "//output//finalAdtlTargetGDOi30.xlsx"))
# targetGDO <- read.xlsx(paste0(wd,"//output//finalTargetGDOi30.xlsx"))
